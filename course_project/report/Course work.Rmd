---
title: "Course project"
author: "Ivan Zarudny, Egor Manin"
date: "January 10, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(ggdendro)
library(spatstat)
library(forecast)
library(lubridate)
```

```{r}
load('../riaa.Rda')
```

# Dataset overview

## Creating heatmap
```{r}
ggplot(data = table, aes(x=Release.date, y=Genre)) +
  xlim(as.Date('2010-01-01'), as.Date('2019-01-01')) +
  geom_raster(aes(fill=table$Certified.Units)) +
  ggtitle(label='Heatmap of certified units', subtitle='From 2010 till 2018') +
  xlab(label='Release date') +
  ylab(label='Genre') +
  theme(legend.position = "bottom") +
  scale_fill_viridis_c(
    option = 'viridis',
    direction = -1,
    name = 'Certified units',
    guide = guide_colorbar(
      direction = 'horizontal',
      barheight = unit(2, units='mm'),
      barwidth = unit(50, units='mm'),
      draw.ulim = F,
      title.position = 'top',
      title.hjust = 0.5,
      label.hjust = 0.5
    )
  )
```

## Slice for genre POP
```{r}
table %>%
  filter(Genre == 'POP') %>%
  ggplot(., aes(x=Release.date, y=Certified.Units)) +
    xlim(as.Date('2010-01-01'), as.Date('2019-01-01')) +
    ylim(0, 1.5e7) +
    geom_line() +
    ggtitle(label='Certified units for genre POP', subtitle='From 2010 till 2018') +
    xlab(label='Release date') +
    ylab(label='Certified units')
```

# Creating models
Using genre POP as reference

## First model

```{r}
table %>%
  filter(Genre == 'POP') %>%
  select(c(Certified.Units, Release.date)) %>%
  group_by(Release.date=floor_date(Release.date, "month")) %>%
  summarise(Certified.Units=sum(Certified.Units)) %>%
  arrange(Release.date) %>%
  select(c(Certified.Units)) %>%
  ts(., start=2000, end=2018+11/12, frequency=12) -> timeseries

checkresiduals(Arima(timeseries, seasonal=c(1,1,0), include.drift=T), plot=T)

ggseasonplot(timeseries)

model.train <- window(timeseries, start=2000, end=2015)
model.test <- window(timeseries, start=2015+1/12, end=2018+11/12)

model <- Arima(model.train, seasonal=c(1,1,0), include.drift=T)
model.forecast <- forecast(model, h=length(model.test))

autoplot(model.test) +
  geom_line(data=model.forecast$mean, show.legend=F, aes(colour='red')) +
  ggtitle(label='Model forecast and actual data', subtitle='Trained model by data filtered from 2000 to 2015') +
  xlab(label='Release date') +
  ylab(label='Certified units')

accuracy.1 <- accuracy(model.forecast, model.test)
remove(list=c('timeseries', 'model.train', 'model.test', 'model', 'model.forecast'))
```

## Filtering dataset from drop outs
```{r}
table %>%
  filter(Genre == 'POP') %>%
  select(c(Certified.Units, Release.date)) %>%
  group_by(Release.date=floor_date(Release.date, "month")) %>%
  summarise(Certified.Units=sum(Certified.Units)) %>%
  mutate(Certified.Units=log(Certified.Units)) %>%
  arrange(Release.date) %>%
  select(c(Certified.Units)) %>%
  ts(., start=2000, end=2018+11/12, frequency=12) -> timeseries

checkresiduals(Arima(timeseries, seasonal=c(1,1,0), include.drift=T), plot=T)

ggseasonplot(timeseries)

model.train <- window(timeseries, start=2000, end=2015)
model.test <- window(timeseries, start=2015+1/12, end=2018+11/12)

model <- Arima(model.train, seasonal=c(1,1,0), include.drift=T)
model.forecast <- forecast(model, h=length(model.test))

autoplot(model.test) +
  geom_line(data=model.forecast$mean, show.legend=F, aes(colour='red')) +
  ggtitle(label='Model forecast and actual data', subtitle='Trained model by data filtered from 2000 to 2015') +
  xlab(label='Release date') +
  ylab(label='Certified units')

accuracy.2 <- accuracy(model.forecast, model.test)
remove(list=c('timeseries', 'model.train', 'model.test', 'model', 'model.forecast'))
```



